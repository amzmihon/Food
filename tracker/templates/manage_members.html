{% extends 'base.html' %}

{% block title %}Manage Members - Meal Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold mb-2">
            <i class="bi bi-people text-primary"></i> Member Management
        </h1>
        <p class="text-muted">Add and manage meal tracking members</p>
    </div>
</div>

<div class="row">
    <!-- Add Member Form -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-person-plus"></i> Add New Member
            </div>
            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add">

                    <div class="mb-3">
                        <label for="name" class="form-label">
                            <i class="bi bi-person"></i> Member Name
                        </label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="Enter name" required>
                    </div>

                    <div class="mb-4">
                        <label for="serial_number" class="form-label">
                            <i class="bi bi-hash"></i> Serial Number
                        </label>
                        <input type="number" class="form-control" id="serial_number" name="serial_number" min="1"
                            placeholder="1" required>
                        <small class="text-muted">Unique number for sorting</small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-circle"></i> Add Member
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card mt-3">
            <div class="card-body text-center">
                <i class="bi bi-people-fill text-primary fs-1 mb-2"></i>
                <h3 class="fw-bold mb-0">{{ members|length }}</h3>
                <p class="text-muted mb-0">Total Members</p>
                <div class="mt-2">
                    <span class="badge bg-success">
                        {{ members|length }} Active
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Members List -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> All Members
            </div>
            <div class="card-body p-0">
                {% if members %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="text-center">Serial</th>
                                <th>Name</th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Weekly Meals</th>
                                <th class="text-end">Total Paid</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in members %}
                            <tr>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ member.serial_number }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-person-circle fs-4 me-2 text-primary"></i>
                                        <strong>{{ member.name }}</strong>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if member.is_active %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Active
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-x-circle"></i> Inactive
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ member.get_weekly_meals }} meals</span>
                                </td>
                                <td class="text-end fw-semibold text-success">
                                    {{ member.get_total_paid|floatformat:2 }} Tk
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <!-- Edit Button -->
                                        <button type="button" class="btn btn-sm btn-primary edit-member-btn"
                                            data-member-id="{{ member.id }}" data-member-name="{{ member.name }}"
                                            title="Edit Name">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>

                                        <!-- Toggle Active/Inactive -->
                                        <form method="POST" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="toggle">
                                            <input type="hidden" name="member_id" value="{{ member.id }}">
                                            <button type="submit"
                                                class="btn btn-sm {% if member.is_active %}btn-warning{% else %}btn-success{% endif %}"
                                                title="{% if member.is_active %}Deactivate{% else %}Activate{% endif %}">
                                                <i
                                                    class="bi bi-{% if member.is_active %}pause-circle{% else %}play-circle{% endif %}"></i>
                                                {% if member.is_active %}Deactivate{% else %}Activate{% endif %}
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted fs-1"></i>
                    <p class="text-muted mt-3 mb-0">No members yet. Add your first member to get started!</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Member Information -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="fw-bold mb-3">
                    <i class="bi bi-info-circle text-primary"></i> Member Management Tips
                </h6>
                <ul class="small mb-0">
                    <li><strong>Serial Number:</strong> Used to order members in tables and reports</li>
                    <li><strong>Active Status:</strong> Only active members appear in meal tracking</li>
                    <li><strong>Deactivate:</strong> Instead of deleting, deactivate members to preserve historical data
                    </li>
                    <li><strong>Weekly Meals:</strong> Shows meals for the current week (Saturday to Friday)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Single Edit Modal (Outside the loop) -->
<div class="modal fade" id="editMemberModal" tabindex="-1" aria-labelledby="editMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMemberModalLabel">
                    <i class="bi bi-pencil-square"></i> Edit Member Name
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="member_id" id="editMemberId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editMemberName" class="form-label">
                            <i class="bi bi-person"></i> Member Name
                        </label>
                        <input type="text" class="form-control" id="editMemberName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Handle edit button clicks to populate the modal
    document.addEventListener('DOMContentLoaded', function () {
        const editButtons = document.querySelectorAll('.edit-member-btn');
        const editModal = new bootstrap.Modal(document.getElementById('editMemberModal'));
        const editMemberId = document.getElementById('editMemberId');
        const editMemberName = document.getElementById('editMemberName');

        editButtons.forEach(button => {
            button.addEventListener('click', function () {
                const memberId = this.getAttribute('data-member-id');
                const memberName = this.getAttribute('data-member-name');

                editMemberId.value = memberId;
                editMemberName.value = memberName;

                editModal.show();
            });
        });
    });
</script>
{% endblock %}